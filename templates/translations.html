<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã“mar B - Translations</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='main.css')}}">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <script type="text/javascript">

      async function fetchProgress() {
        try {
          const response = await fetch("/translation_progress");
          const data = await response.json();
          
          const total = data.completed + data.inProgress + data.remaining;
          const completedPercentage = (data.completed / total) * 100;
          const inProgressPercentage = (data.inProgress / total) * 100;
          const remainingPercentage = (data.remaining / total) * 100;
          
          // Update progress bar widths
          document.getElementById("progress-completed").style.width = completedPercentage + "%";
          document.getElementById("progress-inprogress").style.width = inProgressPercentage + "%";
          document.getElementById("progress-remaining").style.width = remainingPercentage + "%";

          // Update progress bar text content
          document.getElementById("progress-completed").innerText = Math.round(completedPercentage) + "%";
          document.getElementById("progress-inprogress").innerText = Math.round(inProgressPercentage) + "%";
          document.getElementById("progress-remaining").innerText = Math.round(remainingPercentage) + "%";

        } catch (error) {
          console.error("Error fetching progress:", error);
        }
      }
      fetchProgress();

      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(fetchDataAndDrawChart);

      async function fetchDataAndDrawChart() {
        try {
          const response = await fetch('/songs_and_times');
          const data = await response.json();

          // Prepare the data for Google Charts
          const chartData = [['Song Name', 'Time in minutes', { role: 'style' }]];
          data.forEach(song => {
            const timeParts = song[1].split(':');
            const timeInMinutes = parseInt(timeParts[0]) * 60 + parseInt(timeParts[1]) + parseInt(timeParts[2]) / 60;
            chartData.push([song[0], timeInMinutes, '#7B6D8D']);
          });

          // Create the data table
          const dataTable = google.visualization.arrayToDataTable(chartData);

          // Set chart options
          const options = {
            title: 'Time spent translating each song in minutes',
            hAxis: {title: 'Song Name', titleTextStyle: {color: '#333'}},
            vAxis: {title: 'Time Taken (minutes)', minValue: 0},
            legend: {position: 'none'}
          };

          // Instantiate and draw the chart
          const chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
          chart.draw(dataTable, options);
        } catch (error) {
          console.error('Error fetching data or drawing chart:', error);
        }
      }

      async function updateSpotifyEmbed() {
        try {
          const response = await fetch("/get_current_song_id");
          const data = await response.json();
          
          const songId = data.song_id;
          if (songId) {
            document.getElementById("spotify-embed").src = `https://open.spotify.com/embed/track/${songId}?utm_source=generator&theme=0`;
          }
        } catch (error) {
          console.error("Error fetching current song:", error);
        }
      }
      
      fetchProgress();
      updateSpotifyEmbed();
    </script>
  </head>
  
  <body>
    <!--Navigation Bar-->
    {% include 'navbar.html' %}
    
    <!--Total study time-->
    <div id="study-time" style="text-align: center; font-size: 20px; font-weight: bold; margin-top: 10px;"></div>
    <script>
        async function updateStudyTime() {
            try {
                let response = await fetch('/get_total_study');
                let data = await response.json();
                document.getElementById('study-time').innerText = `Total time spent translating: ${data.hours}h ${data.minutes}m`;
            } catch (error) {
                console.error('Error fetching study time:', error);
            }
        }

        updateStudyTime();
    </script>

    <!--Progress bar HERE-->
    <div class="container mt-4" style="margin-bottom: 20px;">
      <div class="progress" style="height: 50px;">
        <div id="progress-completed" class="progress-bar bg-success" style="width: 0%"></div>
        <div id="progress-inprogress" class="progress-bar bg-warning" style="width: 0%"></div>
        <div id="progress-remaining" class="progress-bar bg-danger" style="width: 0%"></div>
      </div>
    </div>

    <!--Title-->
    <h1 style="margin-bottom: 20px;" id="center_this">The <em>Asian Kung-Fu Generation</em> translation project</h1>

    <!--Description and current song-->
    <div class="container">
      <div class="row">
        <div class="col-sm" id=study-time>
          <div class="card text-white bg-dark mb-3" id="translation-card" style="max-width: 40rem;">
            <div class="card-body">
              <h5 class="card-title">Project Preamble</h5>
              <p class="card-text">'The <em>Asian Kung-Fu Generation</em> (AKFG) translation project' is a personal data-visualisation project that also helps me study japanese!
                <br><br>I'm working through translating my favorite songs (30 of them), writing down data about it, and visualising it here!
              </p>
            </div>
          </div>
        </div>
        <div class="col-sm">
          <div class="card text-white bg-dark mb-3" style="max-width: 40rem;">
            <div class="card-body">
              <h5 class="card-title">Currently translating:</h5>
              <p class="card-text"><iframe id="spotify-embed" style="border-radius:12px" src="https://open.spotify.com/embed/track/4EZnEUoKYVG5wfx5pF8Gb7?utm_source=generator&theme=0" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe></p>
            </div>
          </div>
        </div>
      </div>
    </div> 

    <!-- Chart Container -->
    <div class="card text-white bg-dark mb-3" id="center_this">
      <div class="card-body">
        <h5 class="card-title">Translations over time</h5>
        <div id="chart_div" style="width: 60em; height: 30em;"></div>
        <p><small>Figure 1.1, bar chart showing translations over time.</small></p>
      </div>
    </div>

    <!--API's, Languages, & other stuff used-->
    <div class="container" style="margin-left: auto; margin-right: auto;">
      <div class="card text-white bg-dark mb-3">
        <div class="card-body">
          <h5 class="card-title">API's, Languages, & other stuff used</h5>
          <p class="card-text">- My main data source is my <a href="https://docs.google.com/spreadsheets/d/1d-EzIikQ1kvo58Gj6pHKr22lmSphXLe-siMwmwtruyo/edit?usp=sharing" target="_blank">Google Sheet</a>! This is where I write down study times, and have other data about the songs.
          <br>- To set up the sheet, I needed to use the Spotify API to get the names of the songs and how long they where.
          <br>- To get data from this sheet, I'm using the Google Cloud Sheets API.
          <br>- This website is built using the Flask framework (and therefore; Python, HTML/CSS, and some Javascript)
          <br>- Due to the fact that I'm terrible at Javascript, I used Deepseek AI here and there to help out</p>
        </div>
      </div>
    </div>
    
  </body>
</html>